---
- name: Simple playbook to demonstrate EC2 connections over ssh
  hosts: "tag_application_{{ application | replace('-', '_') }}:&tag_environment_{{ environment_name | replace('-', '_') }}"
  any_errors_fatal: true

  vars:
    application: ansible-ssh  # Aligned with Terraform provider-level tags
    instance_tag_name: "{{ hostvars[inventory_hostname].tags.Name }}"

  pre_tasks:
    - name: Ping the hosts
      ansible.builtin.ping:

  tasks:
    - name: Say hello - ansible-lint will complain if a task does not have a name
      ansible.builtin.debug:
        msg: Greetings from {{ hostvars[ansible_host]['public_ip_address'] }}

    - name: Set the hostname to that of the Name tag
      become: true
      ansible.builtin.hostname:
        name: "{{ instance_tag_name }}"
        use: systemd

  post_tasks:
    - name: Say goodbye
      ansible.builtin.debug:
        msg: Goodbye from {{ hostvars[ansible_host]['public_ip_address'] }}
